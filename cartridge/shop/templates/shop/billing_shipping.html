{% extends "shop/checkout.html" %}
{% load i18n mezzanine_tags %}

{% block extra_head %}
{{ block.super }}
<script type="text/javascript">
$(function() {

	var sameShipping = $('#id_same_billing_shipping');

	// prepopulate shipping fields with billing values if "same as" checkbox
	// checked by iterating the billing fields, mapping each billing field name
	// to the shipping field name and setting its value
	$('#checkout-form').submit(function() {
		if (sameShipping.attr('checked')) {
			$('input[name^=billing_]').each(function() {
				var shippingName = this.name.replace('billing_', 'shipping_');
				$('input[name=' + shippingName + ']').attr('value', this.value);
			});
			$('select[name^=billing_]').each(function() {
				var shippingSelected = $(this).children('option[selected]').val();
				var shippingSelName = this.name.replace('billing_', 'shipping_');
				$('select[name=' + shippingSelName + '] option[value=' + shippingSelected +']').attr('selected', 'selected');
			});
		}
	});

	// show/hide shipping fields on change of "same as" checkbox and call on load
	sameShipping.change(function() {
		$('#shipping_fields')[sameShipping.attr('checked') ? 'hide' : 'show']();
	}).change();

});
</script>
{% endblock %}

{% block fields %}
{% if request.cart.has_items %}

{% if not request.user.is_authenticated and settings.SHOP_CHECKOUT_ACCOUNT_ENABLED %}
<p class="checkout-account">
	If you have an existing account or would like to create one, please
    <a href="{{ settings.LOGIN_URL }}?next={{ request.path }}">log in or sign up</a>.
</p>
{% endif %}

<fieldset>
	<legend>{% trans "Billing Details" %}</legend>
	{% fields_for form.billing_detail_fields %}
</fieldset>

<fieldset>
	<legend>{% trans "Delivery Details" %}</legend>
	{% fields_for form.same_billing_shipping_field %}
	<div id="shipping_fields">{% fields_for form.shipping_detail_fields %}</div>
	{% fields_for form.additional_instructions_field %}
</fieldset>

{% if not settings.SHOP_CHECKOUT_STEPS_SPLIT %}
{% include "shop/payment_fields.html" %}
{% endif %}

{% fields_for form.remember_field %}
{% fields_for form.other_fields %}

{% endif %}
{% endblock %}
